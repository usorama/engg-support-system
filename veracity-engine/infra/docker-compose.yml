# Veracity Engine Docker Compose Configuration
#
# Usage:
#   1. Copy .env.example to .env and set your credentials
#   2. Run: docker compose up -d
#
# Configuration is loaded from .env file (STORY-001)
# Image digests pinned for reproducibility (STORY-002)

services:
  neo4j:
    # Pinned to exact digest for reproducibility (STORY-002)
    image: neo4j@sha256:d9e2fb1ba398536e50d22ebc3d5d585baa086c1c0cf8e5b96bdc9e11e87e002a
    container_name: graphrag_neo4j
    ports:
      - "7474:7474" # HTTP
      - "7687:7687" # Bolt
    env_file:
      - .env
    environment:
      - NEO4J_AUTH=${NEO4J_AUTH:-neo4j/password}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
    volumes:
      - ${NEO4J_DATA_PATH:-neo4j_data}:/data
      - ${NEO4J_LOGS_PATH:-neo4j_logs}:/logs
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:7474"]
      interval: ${HEALTH_CHECK_INTERVAL:-30s}
      timeout: ${HEALTH_CHECK_TIMEOUT:-10s}
      retries: ${HEALTH_CHECK_RETRIES:-3}

  neodash:
    image: neo4jlabs/neodash:latest
    container_name: graphrag_neodash
    platform: linux/amd64
    ports:
      - "5005:5005"
    env_file:
      - .env
    environment:
      - NEO4J_URL=bolt://graphrag_neo4j:7687
    depends_on:
      neo4j:
        condition: service_healthy

  ui:
    build: ../ui
    container_name: graphrag_ui
    ports:
      - "5173:5173"
    env_file:
      - .env
    environment:
      - VITE_NEO4J_URI=${VITE_NEO4J_URI:-bolt://localhost:7687}
      - VITE_NEO4J_USER=${VITE_NEO4J_USER:-neo4j}
      - VITE_NEO4J_PASSWORD=${VITE_NEO4J_PASSWORD}
    depends_on:
      neo4j:
        condition: service_healthy
    volumes:
      - ../ui:/app
      - /app/node_modules

volumes:
  neo4j_data:
  neo4j_logs:
