<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESS Monitoring Dashboard</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #333;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .status-healthy { background: #10b981; color: white; }
        .status-degraded { background: #f59e0b; color: white; }
        .status-unhealthy { background: #ef4444; color: white; }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: #16213e;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #333;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .service-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .service-status.healthy { background: #10b981; }
        .service-status.degraded { background: #f59e0b; }
        .service-status.unhealthy { background: #ef4444; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .metric {
            margin-bottom: 12px;
        }

        .metric-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 4px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 600;
        }

        .metric-value.good { color: #10b981; }
        .metric-value.warn { color: #f59e0b; }
        .metric-value.bad { color: #ef4444; }

        .circuit-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .circuit-item {
            background: #0f0f23;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .circuit-name {
            font-size: 12px;
            color: #888;
            margin-bottom: 4px;
        }

        .circuit-state {
            font-size: 14px;
            font-weight: 600;
        }

        .circuit-state.closed { color: #10b981; }
        .circuit-state.open { color: #ef4444; }
        .circuit-state.half_open { color: #f59e0b; }

        .alerts-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .alert-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: #0f0f23;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .alert-severity {
            font-size: 20px;
        }

        .alert-content {
            flex: 1;
        }

        .alert-service {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .alert-message {
            font-size: 13px;
            color: #aaa;
        }

        .alert-time {
            font-size: 11px;
            color: #666;
        }

        .refresh-info {
            text-align: center;
            color: #666;
            font-size: 12px;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error-message {
            background: #ef444420;
            border: 1px solid #ef4444;
            color: #ef4444;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ESS Monitoring Dashboard</h1>
            <div id="overall-status" class="status-badge">Loading...</div>
        </header>

        <div id="error-container"></div>

        <h2 style="margin-bottom: 15px; font-size: 18px;">Services</h2>
        <div class="grid" id="services-grid">
            <div class="loading">Loading services...</div>
        </div>

        <h2 style="margin-bottom: 15px; font-size: 18px;">Circuit Breakers</h2>
        <div class="card" style="margin-bottom: 30px;">
            <div class="circuit-grid" id="circuits-grid">
                <div class="loading">Loading circuits...</div>
            </div>
        </div>

        <h2 style="margin-bottom: 15px; font-size: 18px;">Recent Alerts</h2>
        <div class="card">
            <div class="alerts-list" id="alerts-list">
                <div class="loading">Loading alerts...</div>
            </div>
        </div>

        <div class="refresh-info">
            Auto-refresh every 10 seconds | Last update: <span id="last-update">-</span>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        // Simple HTML escape function to prevent XSS
        function escapeHtml(text) {
            if (typeof text !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function fetchData(endpoint) {
            const response = await fetch(API_BASE + endpoint);
            if (!response.ok) throw new Error('HTTP ' + response.status);
            return response.json();
        }

        function formatTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleTimeString();
        }

        function getStatusClass(status) {
            if (status === 'healthy' || status === 'ok') return 'healthy';
            if (status === 'degraded') return 'degraded';
            return 'unhealthy';
        }

        function renderServices(services) {
            const grid = document.getElementById('services-grid');
            grid.replaceChildren(); // Clear existing content safely

            if (!services || services.length === 0) {
                const loading = document.createElement('div');
                loading.className = 'loading';
                loading.textContent = 'No services found';
                grid.appendChild(loading);
                return;
            }

            services.forEach(function(service) {
                const card = document.createElement('div');
                card.className = 'card';

                const header = document.createElement('div');
                header.className = 'card-header';

                const title = document.createElement('span');
                title.className = 'card-title';
                title.textContent = service.service;

                const statusDot = document.createElement('div');
                statusDot.className = 'service-status ' + getStatusClass(service.status);

                header.appendChild(title);
                header.appendChild(statusDot);
                card.appendChild(header);

                // Status metric
                const statusMetric = createMetric('Status', service.status.toUpperCase(), getStatusClass(service.status));
                card.appendChild(statusMetric);

                // Latency metric
                const latencyClass = service.latency > 10000 ? 'bad' : service.latency > 5000 ? 'warn' : 'good';
                const latencyValue = service.latency >= 0 ? service.latency + 'ms' : 'N/A';
                const latencyMetric = createMetric('Latency', latencyValue, latencyClass);
                card.appendChild(latencyMetric);

                // Failures metric
                const failuresClass = service.consecutiveFailures > 0 ? 'warn' : 'good';
                const failuresMetric = createMetric('Consecutive Failures', String(service.consecutiveFailures), failuresClass);
                card.appendChild(failuresMetric);

                // Error message if present
                if (service.lastError) {
                    const errorMetric = document.createElement('div');
                    errorMetric.className = 'metric';
                    const errorLabel = document.createElement('div');
                    errorLabel.className = 'metric-label';
                    errorLabel.textContent = 'Last Error';
                    const errorValue = document.createElement('div');
                    errorValue.style.color = '#ef4444';
                    errorValue.style.fontSize = '12px';
                    errorValue.textContent = service.lastError;
                    errorMetric.appendChild(errorLabel);
                    errorMetric.appendChild(errorValue);
                    card.appendChild(errorMetric);
                }

                grid.appendChild(card);
            });
        }

        function createMetric(label, value, valueClass) {
            const metric = document.createElement('div');
            metric.className = 'metric';

            const metricLabel = document.createElement('div');
            metricLabel.className = 'metric-label';
            metricLabel.textContent = label;

            const metricValue = document.createElement('div');
            metricValue.className = 'metric-value ' + valueClass;
            metricValue.textContent = value;

            metric.appendChild(metricLabel);
            metric.appendChild(metricValue);
            return metric;
        }

        function renderCircuits(circuits) {
            const grid = document.getElementById('circuits-grid');
            grid.replaceChildren();

            if (!circuits || Object.keys(circuits).length === 0) {
                const loading = document.createElement('div');
                loading.className = 'loading';
                loading.textContent = 'No circuits found';
                grid.appendChild(loading);
                return;
            }

            Object.entries(circuits).forEach(function(entry) {
                const name = entry[0];
                const stats = entry[1];

                const item = document.createElement('div');
                item.className = 'circuit-item';

                const nameDiv = document.createElement('div');
                nameDiv.className = 'circuit-name';
                nameDiv.textContent = name;

                const stateDiv = document.createElement('div');
                stateDiv.className = 'circuit-state ' + stats.state;
                stateDiv.textContent = stats.state.toUpperCase();

                const infoDiv = document.createElement('div');
                infoDiv.style.fontSize = '11px';
                infoDiv.style.color = '#666';
                infoDiv.style.marginTop = '4px';
                infoDiv.textContent = 'Opens: ' + stats.totalOpens + ' | Failures: ' + stats.failures;

                item.appendChild(nameDiv);
                item.appendChild(stateDiv);
                item.appendChild(infoDiv);
                grid.appendChild(item);
            });
        }

        function renderAlerts(alerts) {
            const list = document.getElementById('alerts-list');
            list.replaceChildren();

            if (!alerts || alerts.length === 0) {
                const noAlerts = document.createElement('div');
                noAlerts.className = 'loading';
                noAlerts.style.color = '#10b981';
                noAlerts.textContent = 'No recent alerts';
                list.appendChild(noAlerts);
                return;
            }

            const severityEmoji = {
                critical: '!',
                warning: '!',
                info: 'i'
            };

            alerts.slice(0, 20).forEach(function(alert) {
                const item = document.createElement('div');
                item.className = 'alert-item';

                const severity = document.createElement('div');
                severity.className = 'alert-severity';
                severity.textContent = severityEmoji[alert.severity] || '?';

                const content = document.createElement('div');
                content.className = 'alert-content';

                const serviceDiv = document.createElement('div');
                serviceDiv.className = 'alert-service';
                serviceDiv.textContent = alert.service + ' - ' + alert.severity.toUpperCase();

                const messageDiv = document.createElement('div');
                messageDiv.className = 'alert-message';
                messageDiv.textContent = (alert.message || '').replace(/\n/g, ' ').substring(0, 100) + '...';

                const timeDiv = document.createElement('div');
                timeDiv.className = 'alert-time';
                timeDiv.textContent = formatTime(alert.timestamp) + (alert.acknowledged ? ' - Acknowledged' : '');

                content.appendChild(serviceDiv);
                content.appendChild(messageDiv);
                content.appendChild(timeDiv);

                item.appendChild(severity);
                item.appendChild(content);
                list.appendChild(item);
            });
        }

        function updateOverallStatus(services) {
            const badge = document.getElementById('overall-status');
            const statuses = services.map(function(s) { return s.status; });

            var overall = 'healthy';
            var className = 'status-healthy';

            if (statuses.some(function(s) { return s === 'unhealthy'; })) {
                overall = 'unhealthy';
                className = 'status-unhealthy';
            } else if (statuses.some(function(s) { return s === 'degraded'; })) {
                overall = 'degraded';
                className = 'status-degraded';
            }

            badge.textContent = overall.toUpperCase();
            badge.className = 'status-badge ' + className;
        }

        async function refresh() {
            const errorContainer = document.getElementById('error-container');
            errorContainer.replaceChildren();

            try {
                // Fetch health status
                const healthData = await fetchData('/monitoring/health');
                renderServices(healthData.services);
                renderCircuits(healthData.circuits);
                updateOverallStatus(healthData.services);

                // Fetch alerts
                const alertsData = await fetchData('/monitoring/alerts');
                renderAlerts(alertsData.alerts);

                document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
            } catch (error) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = 'Failed to fetch monitoring data: ' + error.message + '. Make sure the ESS Gateway is running with monitoring enabled.';
                errorContainer.appendChild(errorDiv);
            }
        }

        // Initial load
        refresh();

        // Auto-refresh every 10 seconds
        setInterval(refresh, 10000);
    </script>
</body>
</html>
